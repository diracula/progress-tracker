<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Goal Progress</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>Well Wishes 2026</h2>
<canvas id="chart" width="900" height="450"></canvas>

<script>
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vT4iNJsJrgRh_JtqIBnTLPQXUPS0d15rAbZDF3QHX7iYZd6Oe7aBMdt7faX1ZRL3x9tbD0R7H05Ahaj/pub?gid=1922078669&output=csv";

function allDates2026() {
  const dates = [];
  let d = new Date("2026-01-01");
  const end = new Date("2026-12-31");
  while (d <= end) {
    dates.push(d.toISOString().slice(0, 10));
    d.setDate(d.getDate() + 1);
  }
  return dates;
}

const todayLinePlugin = {
  id: 'todayLine',
  afterDatasetsDraw(chart) {
    const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
    const todayStr = new Date().toISOString().slice(0, 10);
    const xPos = x.getPixelForValue(todayStr);

    if (xPos >= chart.chartArea.left && xPos <= chart.chartArea.right) {
      ctx.save();
      ctx.beginPath();
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      ctx.strokeStyle = 'rgba(150, 150, 150, 0.7)';
      ctx.moveTo(xPos, top);
      ctx.lineTo(xPos, bottom);
      ctx.stroke();
      ctx.restore();
    }
  }
};

fetch(SHEET_URL + "&t=" + Date.now())
  .then(res => res.text())
  .then(csv => {
    const rows = csv.trim().split("\n").map(r => r.split(","));
    const headers = rows[0].map(h => h.trim().toLowerCase());
    const body = rows.slice(1);
    const allDates = allDates2026();
    const datasets = [];

    for (let c = 0; c < headers.length; c++) {
      if (!headers[c].includes("date")) continue;

      let vCol = c + 1;
      while (vCol < headers.length && headers[vCol] === "") vCol++;
      if (vCol >= headers.length) continue;

      const name = rows[0][c].replace(/date/i, "").trim() || "Goal";
      let goal = null;
      const valuesByDate = {};

      body.forEach(r => {
        const d = r[c];
        const v = parseFloat(r[vCol]);
        if (!d || isNaN(v)) return;
        if (d.toLowerCase() === "goal") { goal = v; } 
        else { valuesByDate[d] = v; }
      });

      const rawValues = allDates.map(d => d in valuesByDate ? valuesByDate[d] : null);
      const baseline = rawValues.find(v => v !== null);
      const baselineIndex = rawValues.findIndex(v => v !== null);

      if (baseline === undefined || goal === null || goal === baseline) continue;

      const progress = rawValues.map(v => v === null ? null : (v - baseline) / (goal - baseline) * 100);
      const colour = `hsl(${datasets.length * 67 % 360}, 70%, 50%)`;

      datasets.push({
        label: name,
        data: progress,
        borderColor: colour,
        backgroundColor: colour,
        borderWidth: 2,
        spanGaps: true
      });

      const goalLine = allDates.map((_, i) =>
        i < baselineIndex ? null : (i - baselineIndex) / (allDates.length - 1 - baselineIndex) * 100
      );

      datasets.push({
        label: name + " benchmark",
        data: goalLine,
        borderColor: colour,
        borderDash: [6, 6],
        borderWidth: 2,
        pointRadius: 0,
        tension: 0
      });
    }

    new Chart(document.getElementById("chart"), {
      type: "line",
      data: {
        labels: allDates,
        datasets
      },
      plugins: [todayLinePlugin],
      options: {
        responsive: true,
        layout: {
          padding: {
            top: 10 // Space between H2 header and the legend
          }
        },
        interaction: { mode: "nearest", intersect: false },
        scales: {
          x: {
            ticks: {
              autoSkip: true,
              maxRotation: 0,
              callback: function(val, idx) {
                const dStr = allDates[idx];
                if (dStr.endsWith("-01") || dStr === "2026-12-31") {
                  const d = new Date(dStr);
                  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
                return null;
              }
            }
          },
          y: {
            beginAtZero: true,
            max: 100, // Capped at exactly 100%
            title: { display: true, text: "Progress (%)" }
          }
        },
        plugins: {
          legend: {
            position: "top", // Default center-top
            labels: {
              padding: 20,   // Space between the legend items and the chart lines
              filter: item => !item.text.endsWith(" benchmark")
            }
          }
        }
      }
    });
  });
</script>

</body>
</html>
