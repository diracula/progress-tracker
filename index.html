<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Goal Progress</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>Progress Toward Goals (%)</h2>
<canvas id="chart" width="900" height="450"></canvas>

<script>
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vT4iNJsJrgRh_JtqIBnTLPQXUPS0d15rAbZDF3QHX7iYZd6Oe7aBMdt7faX1ZRL3x9tbD0R7H05Ahaj/pub?gid=1922078669&output=csv";

// Generate all dates in 2026
function allDates2026() {
  const dates = [];
  let d = new Date("2026-01-01");
  const end = new Date("2026-12-31");

  while (d <= end) {
    dates.push(d.toISOString().slice(0, 10));
    d.setDate(d.getDate() + 1);
  }
  return dates;
}

fetch(SHEET_URL + "&t=" + Date.now())
  .then(res => res.text())
  .then(csv => {
    const rows = csv.trim().split("\n").map(r => r.split(","));

    const names = rows[0].slice(1);
    const goals = rows[1].slice(1).map(Number);
    const dataRows = rows.slice(2);

    // Build map: date -> values[]
    const dataByDate = {};
    dataRows.forEach(r => {
      const date = r[0];
      if (!date) return;
      dataByDate[date] = r.slice(1).map(v =>
        v === "" ? null : Number(v)
      );
    });

    const dates = allDates2026();
    const datasets = [];

    names.forEach((name, i) => {
      const rawValues = dates.map(d =>
        dataByDate[d]?.[i] ?? null
      );

      const baseline = rawValues.find(v => v !== null);
      const goal = goals[i];

      if (baseline === undefined || goal === baseline) return;

      const progress = rawValues.map(v =>
        v === null ? null : (v - baseline) / (goal - baseline) * 100
      );

      // Progress line
      datasets.push({
        label: name,
        data: progress,
        borderWidth: 2,
        spanGaps: true
      });

      // Ideal goal line (0 â†’ 100 across year)
      datasets.push({
        label: name + " goal",
        data: dates.map((_, idx) =>
          idx / (dates.length - 1) * 100
        ),
        borderDash: [6, 6],
        borderWidth: 2,
        pointRadius: 0,
        tension: 0
      });
    });

    new Chart(document.getElementById("chart"), {
      type: "line",
      data: {
        labels: dates,
        datasets
      },
      options: {
        responsive: true,
        scales: {
          x: {
            ticks: {
              maxTicksLimit: 12
            }
          },
          y: {
            title: {
              display: true,
              text: "Progress (%)"
            }
          }
        },
        interaction: {
          mode: "nearest",
          intersect: false
        },
        plugins: {
          legend: {
            labels: {
              filter: item => !item.text.endsWith(" goal")
            }
          }
        }
      }
    });
  });
</script>

</body>
</html>
